# ‚úÖ –ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. DownloadController
**–§–∞–π–ª:** `app/Http/Controllers/DownloadController.php`

–ú–µ—Ç–æ–¥—ã:
- ‚úÖ `download($token)` - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ —Ç–æ–∫–µ–Ω—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–∞—â–∏—Ç—ã

#### –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ (`expires_at`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π (`download_limit`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ (`payment_status = 'paid'`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º:
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π (–æ—Ç `storage/app`)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—É—Ç–µ–π –≤ `public` (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

#### –°—á–µ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–µ—Ä–µ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º

### 3. –†–æ—É—Ç–∏–Ω–≥
```
GET /download/{token}  - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ —Ç–æ–∫–µ–Ω—É
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ `/download` –∏–∑ RedirectMiddleware
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ `download` –∏–∑ —Ä–æ—É—Ç–∞ `/{slug}`

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:
1. **–¢–æ–∫–µ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (64 —Å–∏–º–≤–æ–ª–∞, —Å–ª—É—á–∞–π–Ω—ã–µ)
2. **–¢–æ–∫–µ–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã** - –∫–∞–∂–¥—ã–π `OrderDownload` –∏–º–µ–µ—Ç —Å–≤–æ–π —Ç–æ–∫–µ–Ω
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã** - —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
4. **–õ–∏–º–∏—Ç—ã —Å–∫–∞—á–∏–≤–∞–Ω–∏–π** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 —Ä–∞–∑
5. **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –≥–æ–¥ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–∫—É–ø–∫–∏
6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–∏** - —Ñ–∞–π–ª –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (hotlinking):
- ‚úÖ –§–∞–π–ª—ã –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `public` (–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø)
- ‚úÖ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≥–∞–¥–∞—Ç—å —Ç–æ–∫–µ–Ω (64 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞)

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ `CheckoutController`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Å `file_path` —Å–æ–∑–¥–∞–µ—Ç—Å—è `OrderDownload`
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω: `Str::random(64)`
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ª–∏–º–∏—Ç—ã: `download_limit = 5`, `expires_at = now()->addYear()`

### –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ `/download/{token}`
2. `DownloadController` –Ω–∞—Ö–æ–¥–∏—Ç `OrderDownload` –ø–æ —Ç–æ–∫–µ–Ω—É
3. –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
   - –¢–æ–∫–µ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ –∏—Å—Ç–µ–∫
   - –õ–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω
   - –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω
   - –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å—á–µ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
5. –§–∞–π–ª –æ—Ç–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ OrderDownload

### –ü–æ–ª—è:
- `download_token` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω (64 —Å–∏–º–≤–æ–ª–∞)
- `download_count` - –°—á–µ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
- `download_limit` - –õ–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
- `expires_at` - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –≥–æ–¥)
- `order_id` - –°–≤—è–∑—å —Å –∑–∞–∫–∞–∑–æ–º
- `order_item_id` - –°–≤—è–∑—å —Å –ø–æ–∑–∏—Ü–∏–µ–π –∑–∞–∫–∞–∑–∞
- `user_id` - –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `email` - Email –ø–æ–∫—É–ø–∞—Ç–µ–ª—è

### –ú–µ—Ç–æ–¥—ã –º–æ–¥–µ–ª–∏:
- `canDownload()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
- `incrementDownloadCount()` - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å —Ç–æ–≤–∞—Ä–æ–º, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å `file_path`
2. –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å `payment_status` –≤ –ë–î)
3. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ `order_downloads` —Ç–∞–±–ª–∏—Ü—ã:
   ```sql
   SELECT download_token FROM order_downloads WHERE order_id = <id> LIMIT 1;
   ```
4. –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ: `http://localhost:8000/download/{token}`
5. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–∫–∞—á–∞—Ç—å—Å—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã:
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚Üí 404
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ ‚Üí 403
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ ‚Üí 403
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ ‚Üí 403

---

## üìÅ –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
storage/
  app/
    products/          # –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ç–æ–≤–∞—Ä–æ–≤
      file1.zip
      file2.exe
    ...
```

### –í –ë–î (`products.file_path`):
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: `products/file1.zip` (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ `storage/app`)
- –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å: `/full/path/to/file.zip`

---

## ‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç:**
   - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ `/account/downloads`
   - –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å —Ç–æ–∫–µ–Ω–∞–º–∏
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö –∏ —Å—Ä–æ–∫–∞—Ö

2. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–æ–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
   - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–µ–º—Å—è –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
